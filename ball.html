<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Ball</title>
  <link rel="stylesheet" href="css/main.css" media="screen" title="no title" charset="utf-8">
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js" charset="utf-8"></script> -->
  <script src="js/jquery.min.js" charset="utf-8"></script>
</head>

<body>
  <form id="form1" runat="server">
    <input type='file' id="imgInp" />
    <img id="blah" src="#" alt="your image" style="display:none;" />
  </form>
  <div class="mydivv"></div>
  <!-- <script src="./bower_components/caman/dist/caman.min.js" charset="utf-8"></script> -->
  <script src="js/three.js" charset="utf-8"></script>
  <script src="js/OrbitControls.js" charset="utf-8"></script>
  <script src="js/OBJLoader.js" charset="utf-8"></script>
  <script src="js/TextGeometry.js" charset="utf-8"></script>
  <script src="js/TransformControls.js" charset="utf-8"></script>
  <!-- <script src="bower_components/threex.dynamictexture/threex.dynamictexture.js"></script> -->
  <script type="text/javascript">
    // Creating variables at one place
    var scene, camera, renderer,
      width, height, light,
      loader, material, mesh;

    // methods to call
    init();
    animate();

    // defining methods
    function init() {
      // Creating scene
      scene = new THREE.Scene();
      width = window.innerWidth;
      height = window.innerHeight;

      // Creating renderer
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
      });
      renderer.setSize(width, height);
      document.body.appendChild(renderer.domElement);
      renderer.setClearColor(0xffffff, 1);
      renderer.recieveShadow = true;
      renderer.autoClear = false;

      // Creating camera
      camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
      camera.position.set(0, 0, 6);
      scene.add(camera);

      // Adding Controls
      var controls = new THREE.OrbitControls(camera, renderer.domElement);
      // controls.enableRotate = false;
      controls.enableZoom = false;

      // Updating viewport
      window.addEventListener('resize', function() {
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      });

      // Adding Ambient light
      amblight = new THREE.AmbientLight(0xffffff);
      scene.add(amblight);

      // Adding Directional light
      dirlight = new THREE.DirectionalLight(0xffffff, 0.5);
      dirlight.shadowCameraNear = 1;
      dirlight.shadowCameraFar = 150;
      dirlight.castshadow = true;
      //dirlight.castShadow = true;
      //dirlight.shadowDarkness = 0.5;
      //scene.add(dirlight);

      var spotLight = new THREE.SpotLight(0xffffff);
      spotLight.position.set(1000, 1000, 1000);
      spotLight.castShadow = true;
      camera.add(spotLight);

      //Loading json
      // loader = new THREE.JSONLoader();
      // loader.load('js/ball.js', function(geometry) {
      //   var texture = THREE.ImageUtils.loadTexture("texture.jpg");
      //   texture.wrapS = THREE.RepeatWrapping;
      //   texture.wrapT = THREE.RepeatWrapping;
      //   material = new THREE.MeshBasicMaterial({
      //     map: texture
      //   });
      //   mesh = new THREE.Mesh(geometry, material);
      //   var model = new THREE.Object3D();
      //   model.add(mesh);
      //   // model.scale.set(5, 5, 5);
      //   // model.position.set(-10, -20, 0);
      //   scene.add(model);
      // });

      // DYANMIMC TEXT
      // var dynamicTexture = new THREEx.DynamicTexture(512, 512);
      // dynamicTexture.texture.needsUpdate = true;
      //
      // var url = 'img/ball_texture3.jpg';
      // var image = document.createElement('img');
      // image.src = url;
      // image.addEventListener('load', function() {
      //   dynamicTexture.drawImage(image, 0, 0);
      //   //var textureLoader = new THREE.TextureLoader();
      //   dynamicTexture.drawText('HarsH', 0, 256, 'black');
      // });

      var geometry = new THREE.SphereGeometry(1, 50, 50);
      var texture2 = new THREE.TextureLoader();
      var url = 'img/ball_texture3.jpg';
      texture2.load(
        url,
        function(texture) {
          var material = new THREE.MeshPhongMaterial({
            map: texture
          });
          sphere = new THREE.Mesh(geometry, material);
          sphere.castShadow = true;
          sphere.rotation.y = -5.5;
          sphere.rotation.z = -1;
          scene.add(sphere);
        },
        function(xhr) {
          console.log((xhr.loaded / xhr.total * 100) + '% loaded');
        },
        function(xhr) {
          console.log('An error happened');
        }
      );

      // var c = document.getElementsByTagName('canvas');
      // var ctx = c.getContext("2d");
      // var imageObj1 = new Image();
      // var imageObj2 = new Image();
      // imageObj1.src = "img/ball_texture3.jpg"
      // imageObj1.onload = function() {
      //   ctx.drawImage(imageObj1, 0, 0, 328, 526);
      //   imageObj2.src = "2.png";
      //   imageObj2.onload = function() {
      //     ctx.drawImage(imageObj2, 15, 85, 300, 300);
      //     var img = c.toDataURL("image/png");
      //     document.write('<img src="' + img + '" width="328" height="526"/>');
      //   }
      // };
      var canvas = document.createElement("canvas");
      $("canvas").addClass("mycanvas");
      canvas.width = 1000;
      canvas.height = 667;
      var c = canvas.getContext("2d");
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            $('#blah').attr('src', e.target.result);
            src = $('#blah').attr('src');
            var image2 = new Image();
            $(image2).attr('id', 'myimage2');
            $('.mydivv').append('<img src="' + src + '" id="harshimage"></img>');
            $('.mydivv').css('display', 'none');
            image2.src = src;
            // var imgW = image2.width;
            // var imgH = image2.height;
            // var r,g,b,avg;
            // for(var p = 0, len = image2.length; p < len; p+=4) {
            //     r = image2[p]
            //     g = image2[p+1];
            //     b = image2[p+2];
            //     avg = Math.floor((r+g+b)/3);
            //     image2[p] = image2[p+1] = image2[p+2] = avg;
            // }
            // c.drawImage(image1, 0, 0, 1000, 667, 0, 0, 1000, 667);
            // c.drawImage(image2, 0, 0, 500, 500, 0, 100, 200, 200);
            // var mmm = tintImage(image2, "#d2c32b");
            //image2.src = src;
            var selectImg = '';
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            var originalPixels = null;
            var currentPixels = null;
            var color = '';
            var fullimg = '';
            canvas.width = 1000;
            canvas.height = 667;

            // Function for convert Hexdecimal code into RGB color
            function HexToRGB(Hex) {
              var Long = parseInt(Hex.replace(/^#/, ""), 16);
              return {
                R: (Long >>> 16) & 0xff,
                G: (Long >>> 8) & 0xff,
                B: Long & 0xff
              };
            }
            // Function to fill the color of generated image
            function fillColor(path) {
              color = path;

              if (!originalPixels) return; // Check if image has loaded
              var newColor = HexToRGB(color);

              for (var I = 0, L = originalPixels.data.length; I < L; I += 4) {
                if (currentPixels.data[I + 3] > 0) {
                  currentPixels.data[I] = newColor.R;
                  currentPixels.data[I + 1] = newColor.G;
                  currentPixels.data[I + 2] = newColor.B;
                }
              }

              var image1 = new Image();
              image1.src = "img/ball_texture3.jpg";
              ctx.drawImage(image1, 0, 0, 1000, 667, 0, 0, 1000, 667);
              var cann = document.createElement("canvas");
              cann.width = selectImg.width;
              cann.height = selectImg.height;
              var ctc = cann.getContext("2d");
              ctc.putImageData(currentPixels, 0, 0);
              var newImm = new Image();
              newImm.src = cann.toDataURL("image/png");
              ctx.drawImage(newImm, 0, 0, 400, 400, 0, 100, cann.width / 2, cann.height / 2);
              fullimg = canvas.toDataURL("image/png");
            }

            // Function for draw a image
            function overalayColor(himg, color) {
              fullimg = himg[0];

              img = new Image();
              img.src = himg.src;
              selectImg = himg;
              canvas.width = 1000;
              canvas.height = 667;

              ctx.drawImage(selectImg, 0, 0, selectImg.naturalWidth, selectImg.naturalHeight, 0, 0, selectImg.width, selectImg.height);
              originalPixels = ctx.getImageData(0, 0, selectImg.width, selectImg.height);
              currentPixels = ctx.getImageData(0, 0, selectImg.width, selectImg.height);

              selectImg.onload = null;
              fillColor(color);
            }
            overalayColor(document.getElementById('harshimage'), "#d2c32b");
            //c.drawImage(image1, 0, 0, 1000, 667, 0, 0, 1000, 667);
            c.drawImage(image2, 0, 0, 500, 500, 0, 100, 200, 200);
            var imgsrc = canvas.toDataURL("image/png", 1.0);
            var geometry = new THREE.SphereGeometry(1, 50, 50);
            var textur = new THREE.TextureLoader();
            textur.load(
              fullimg,
              function(texture) {
                var material = new THREE.MeshPhongMaterial({
                  map: texture
                });
                material.map.needsUpdate = true;
                var mysphere = new THREE.Mesh(geometry, material);
                mysphere.rotation.y = -5.5;
                mysphere.rotation.z = -1;
                scene.add(mysphere);
              },
              function(xhr) {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
              },
              function(xhr) {
                console.log('An error happened');
              }
            );
          }
          reader.readAsDataURL(input.files[0]);
        }
      }
      $("#imgInp").change(function() {
        readURL(this);
        scene.remove(sphere);
      });

      function tintImage(imgElement,tintColor) {
        // create hidden canvas (using image dimensions)
        var canvas = document.createElement("canvas");
        var c = canvas.getContext("2d");
        //c.drawImage(imgElement,0,0);
        var map = c.getImageData(0,0,500,500);
        var imdata = map.data;

        // convert image to grayscale
        var r,g,b,avg;
        for(var p = 0, len = imdata.length; p < len; p+=4) {
            r = imdata[p]
            g = imdata[p+1];
            b = imdata[p+2];
            avg = Math.floor((r+g+b)/3);
            imdata[p] = imdata[p+1] = imdata[p+2] = avg;
        }

        c.putImageData(map,0,0);

        // overlay filled rectangle using lighter composition
        c.globalCompositeOperation = "lighter";
        c.globalAlpha = 0.5;
        c.fillStyle = tintColor;
        c.fillRect(0,0,canvas.width,canvas.height);

        // replace image source with canvas data
        var srcm = canvas.toDataURL();
        return srcm;
      }

      // Native Sphere


      //var texture = THREE.ImageUtils.loadTexture('ball_texture3.jpg');
      // loader = new THREE.JSONLoader();
      // loader.load('js/ball.json', function(geometry) {
      //   var texture2 = new THREE.TextureLoader();
      //   texture2.load(
      //     'img/ball_texture3.jpg',
      //     function(texture) {
      //       var material = new THREE.MeshPhongMaterial({ map: texture });
      //       var sphere = new THREE.Mesh(geometry, material);
      //       sphere.castShadow = true;
      //       sphere.rotation = false;
      //       scene.add(sphere);
      //     },
      //     function(xhr) {
      //       console.log((xhr.loaded / xhr.total * 100) + '% loaded');
      //     },
      //     function(xhr) {
      //       console.log('An error happened');
      //     }
      //   );
      // });

      //Get the selected color code
      // $('select').change(function() {
      //   overalayColor(jQuery(this).val());
      // });

    }

    function animate() {
      requestAnimationFrame(animate);
      //mesh.rotation.z += 0.01;
      renderer.render(scene, camera);
    }

    $.getJSON("js/shirt.json", function(json) {
      //console.log(json.materials);
      for (i = 0; i <= 38; i++) {
        //json.materials[i].color = 11316396;
      }
      //console.log(json.materials[0].color);
    });

    var onKeyDown = function(event) {
      if (event.keyCode == 67) { // when 'c' is pressed
        material.color.setHex(0xff0000); // there is also setHSV and setRGB
      } else if (event.keyCode == 68) { // when 'd' is pressed
        material.color.setHex(0x00ff00); // there is also setHSV and setRGB
      } else if (event.keyCode == 69) { // when 'e' is pressed
        material.color.setHex(0x0000ff); // there is also setHSV and setRGB
      }
    };
    document.addEventListener('keydown', onKeyDown, false);
  </script>
</body>

</html>
