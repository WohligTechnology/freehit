<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Bag</title>
  <link rel="stylesheet" href="css/main.css" media="screen" title="no title" charset="utf-8">
  <script src="js/jquery.min.js" charset="utf-8"></script>
</head>

<body>
  <form id="form1" runat="server">
    <input type='file' id="imgInp" />
    <img id="blah" src="#" alt="your image" style="display:none;" />
  </form>
  <div class="colors" style="display: none;">
    <span id="red" style="width: 50px; height: 50px; background-color: #f00; display: block; cursor: pointer;"></span>
    <span id="green" style="width: 50px; height: 50px; background-color: #0f0; display: block; cursor: pointer;"></span>
    <span id="blue" style="width: 50px; height: 50px; background-color: #00f; display: block; cursor: pointer;"></span>
  </div>
  <script src="./bower_components/caman/dist/caman.min.js" charset="utf-8"></script>
  <script src="js/three.js" charset="utf-8"></script>
  <script src="js/OrbitControls.js" charset="utf-8"></script>
  <script src="js/OBJLoader.js" charset="utf-8"></script>
  <script type="text/javascript">

  var scene, camera, renderer, width, height, light, loader, material, mesh;

  init();
  animate();

  function init() {
    scene = new THREE.Scene();
    width = window.innerWidth;
    height = window.innerHeight;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    document.body.appendChild(renderer.domElement);
    renderer.setClearColor(0xffffff, 1);
    renderer.recieveShadow = true;

    camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 10000);
    camera.position.set(7, 7, 7);
    scene.add(camera);

    var controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableZoom = false;

    window.addEventListener('resize', function() {
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    });

    amblight = new THREE.AmbientLight(0xffffff);
    scene.add(amblight);

    dirlight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirlight.shadowCameraNear = 1;
    dirlight.shadowCameraFar = 150;
    dirlight.castshadow = true;

    var spotLight = new THREE.SpotLight(0xffffff);
    spotLight.position.set(1000, 1000, 1000);
    spotLight.castShadow = true;
    camera.add(spotLight);

    loader = new THREE.JSONLoader();
    loader.load('js/bag2.json', function(geometry) {
      var texture2 = new THREE.TextureLoader();
      var url = 'img/bag.jpg';
      texture2.load(
        url,
        function(texture) {
          var material = new THREE.MeshPhongMaterial({
            map: texture
          });
          mesh = new THREE.Mesh(geometry, material);
          mesh.castShadow = true;
          mesh.rotation.x = 0;
          mesh.rotation.y = 0;
          mesh.rotation.z = 0;
          //mesh.material.color.set(0x453897);
          scene.add(mesh);
        },
        function(xhr) {
          console.log((xhr.loaded / xhr.total * 100) + '% loaded');
        },
        function(xhr) {
          console.log('An error happened');
        }
      );
    });

    var canvas = document.createElement("canvas");
    $("canvas").addClass("mycanvas");
    canvas.width = 1024;
    canvas.height = 1024;
    var c = canvas.getContext("2d");
    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
          $('#blah').attr('src', e.target.result);
          src = $('#blah').attr('src');
          var image1 = new Image();
          image1.src = "img/bag.jpg";
          var image2 = new Image();
          $(image2).attr('id', 'myimage2');
          image2.src = src;
          c.drawImage(image1, 0, 0, 1024, 1024, 0, 0, 1024, 1024);
          c.drawImage(image2, 0, 0, 500, 500, 50, 100, 500, 500);
          var imgsrc = canvas.toDataURL("image/png", 1.0);
          loader = new THREE.JSONLoader();
          loader.load("js/bag2.json", function(geometry) {
            var textur = new THREE.TextureLoader();
            textur.load(
              imgsrc,
              function(texture) {
                var material = new THREE.MeshPhongMaterial({
                  map: texture
                });
                var mesh = new THREE.Mesh(geometry, material);
                mesh.castShadow = true;
                mesh.rotation.x = 0;
                mesh.rotation.y = 0;
                mesh.rotation.z = 0;
                scene.add(mesh);
              },
              function(xhr) {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
              },
              function(xhr) {
                console.log('An error happened');
              }
            );
          });
        }
        reader.readAsDataURL(input.files[0]);
      }
    }
    $("#imgInp").change(function() {
      readURL(this);
      scene.remove(mesh);
    });

    $('#red').click(function() { mesh.material.color.set(0xff0000) });
    $('#green').click(function() { mesh.material.color.set(0x00ff00); });
    $('#blue').click(function() { mesh.material.color.set(0x0000ff); });

  }

  function animate() {
    requestAnimationFrame(animate);
    //mesh.rotation.z += 0.01;
    renderer.render(scene, camera);
  }

  </script>
</body>
</html>
